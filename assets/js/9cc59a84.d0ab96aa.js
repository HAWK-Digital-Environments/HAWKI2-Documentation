"use strict";(self.webpackChunkdocs_site=self.webpackChunkdocs_site||[]).push([[681],{1615:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"HAWKI/Architecture/Broadcasting","title":"Broadcasting","description":"Overview of the Broadcasting Process","source":"@site/docs/HAWKI/3-Architecture/5-Broadcasting.md","sourceDirName":"HAWKI/3-Architecture","slug":"/HAWKI/Architecture/Broadcasting","permalink":"/HAWKI2-Documentation/HAWKI/Architecture/Broadcasting","draft":false,"unlisted":false,"editUrl":"https://github.com/hawk/your-project/edit/main/docs/HAWKI/3-Architecture/5-Broadcasting.md","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7},"sidebar":"HAWKI_Sidebar","previous":{"title":"Model Connection","permalink":"/HAWKI2-Documentation/HAWKI/Architecture/Model Connection"},"next":{"title":"Mail Service","permalink":"/HAWKI2-Documentation/HAWKI/Architecture/Mail Service"}}');var r=s(4848),t=s(8453);const a={sidebar_position:7},c=void 0,o={},l=[{value:"Overview of the Broadcasting Process",id:"overview-of-the-broadcasting-process",level:2},{value:"Broadcasting Flow",id:"broadcasting-flow",level:3},{value:"Client-Side Reception",id:"client-side-reception",level:3},{value:"Libraries and Technologies",id:"libraries-and-technologies",level:2},{value:"Security Considerations",id:"security-considerations",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"overview-of-the-broadcasting-process",children:"Overview of the Broadcasting Process"}),"\n",(0,r.jsx)(n.p,{children:"The HAWKI2 system implements a robust message broadcasting architecture to deliver real-time encrypted\nmessages to all members of a room. This process combines Laravel's queueing and broadcasting systems to\nensure efficient and reliable delivery while maintaining end-to-end encryption."}),"\n",(0,r.jsxs)(n.p,{children:["As is metioned in the ",(0,r.jsx)(n.a,{href:"/HAWKI2-Documentation/HAWKI/Architecture/Encryption",children:"Encryption"})," section, in the groupchat rooms if the AI model is mentioned in the message, the chatlog will be prepared and sent to StreamController, also including a derived encryption key to be used by the server.\nAfter receiving the answer from the AI model, the server needs to broadcast the message to all the room members, that have established the connection through websocket channels."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"image",src:s(7555).A+"",width:"1216",height:"1395"})}),"\n",(0,r.jsx)(n.h3,{id:"broadcasting-flow",children:"Broadcasting Flow"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"1. Message Creation and Encryption"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"When a user sends a message, it's first encrypted client-side using the room key"}),"\n",(0,r.jsx)(n.li,{children:"The encrypted message (ciphertext, IV, and tag) is sent to the server"}),"\n",(0,r.jsx)(n.li,{children:"The server creates a message record in the database"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2. Job Dispatching"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["After persisting the message, the RoomController dispatches a SendMessage job:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"SendMessage::dispatch($message, false)->onQueue('message_broadcast');\n"})}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"This job is placed on a dedicated queue named 'message_broadcast'"}),"\n",(0,r.jsx)(n.li,{children:"The queue allows the server to handle broadcasting asynchronously without blocking the response"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"3. Queue Processing"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Laravel's queue worker processes the queued job"}),"\n",(0,r.jsxs)(n.li,{children:["The system uses a database queue driver (configured in ",(0,r.jsx)(n.code,{children:"queue.php"}),")"]}),"\n",(0,r.jsx)(n.li,{children:"This ensures messages are not lost if the system crashes during processing"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"4. Broadcasting Event Creation"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The SendMessage job prepares message data and creates a RoomMessageEvent"}),"\n",(0,r.jsx)(n.li,{children:"This event includes all encrypted message data"}),"\n",(0,r.jsx)(n.li,{children:"The event is formatted with metadata needed by clients for proper handling"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"5. Event Broadcasting"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The RoomMessageEvent implements Laravel's ShouldBroadcast interface"}),"\n",(0,r.jsxs)(n.li,{children:["The event is broadcasted to a private channel specific to the room:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"public function broadcastOn(): array {\n    $slug = Room::findOrFail($this->data['messageData']['room_id'])->slug;\n    return [new PrivateChannel('Rooms.' . $slug)];\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"6. WebSocket Delivery"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Laravel Reverb (configured in ",(0,r.jsx)(n.code,{children:"reverb.php"}),") handles the WebSocket connections"]}),"\n",(0,r.jsx)(n.li,{children:"Laravel Echo on the client side listens for these events"}),"\n",(0,r.jsx)(n.li,{children:"The connection is authenticated using Laravel Sanctum"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"image",src:s(4392).A+"",width:"1765",height:"516"})}),"\n",(0,r.jsx)(n.h3,{id:"client-side-reception",children:"Client-Side Reception"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"1. Channel Subscription"})}),"\n",(0,r.jsx)(n.p,{children:"When a user enters a room, the client subscribes to the room's private channel:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"window.Echo.private(webSocketChannel)\n    .listen('RoomMessageEvent', async (e) => {\n        // Handle the incoming message\n    });\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2. Message Processing"})}),"\n",(0,r.jsx)(n.p,{children:"Upon receiving a message, the client:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Retrieves the appropriate key from the user's keychain"}),"\n",(0,r.jsx)(n.li,{children:"Decrypts the message using the room key or AI key"}),"\n",(0,r.jsx)(n.li,{children:"Updates the UI with the decrypted content"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"3. Typing Indicators"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Real-time typing indicators use ",(0,r.jsx)(n.strong,{children:"whisper channels"})]}),"\n",(0,r.jsx)(n.li,{children:"These side-channel communications don't persist to the database"}),"\n",(0,r.jsx)(n.li,{children:"Provide immediate feedback without requiring full broadcasts"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"libraries-and-technologies",children:"Libraries and Technologies"}),"\n",(0,r.jsx)(n.p,{children:"The broadcasting system leverages several key technologies:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"1. Laravel Echo"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Client-side JavaScript library for subscribing to WebSocket channels"}),"\n",(0,r.jsx)(n.li,{children:"Handles connection maintenance and reconnection logic"}),"\n",(0,r.jsx)(n.li,{children:"Provides a simple API for listening to events"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2. Laravel Reverb"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"WebSocket server implementation by Laravel"}),"\n",(0,r.jsx)(n.li,{children:"Configured as the primary broadcast driver"}),"\n",(0,r.jsx)(n.li,{children:"Handles authentication, channel management and scaling"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"3. Laravel Queues"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Uses the database driver for reliable message processing"}),"\n",(0,r.jsx)(n.li,{children:"Separates the broadcasting process from the web request cycle"}),"\n",(0,r.jsx)(n.li,{children:"Allows for better performance and fault tolerance"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"4. Laravel Events"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The event system ties everything together"}),"\n",(0,r.jsx)(n.li,{children:"RoomMessageEvent class defines the data structure and target channels"}),"\n",(0,r.jsx)(n.li,{children:"Implements ShouldBroadcast for automatic WebSocket delivery"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"1. Private Channels"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"All communication happens on private channels that require authentication"}),"\n",(0,r.jsx)(n.li,{children:"Channel names include the room slug, isolating conversations"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2. End-to-End Encryption"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"All message content remains encrypted throughout the broadcasting process"}),"\n",(0,r.jsx)(n.li,{children:"The server only routes the encrypted data without access to decryption keys"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"3. Authentication"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Channel subscriptions are authenticated via Laravel Sanctum"}),"\n",(0,r.jsx)(n.li,{children:"Only room members can subscribe to the room's channel"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This comprehensive broadcasting architecture ensures that messages are delivered efficiently and\nsecurely to all room members, maintaining the end-to-end encryption that is core to HAWKI2's security\nmodel."})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},4392:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/broadcasting-bcc95c891a61f0e7e8365b6e7c11a350.png"},7555:(e,n,s)=>{s.d(n,{A:()=>i});const i=s.p+"assets/images/roomMsg-58956aa76b0180ba1638f181cfae6fe1.png"},8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>c});var i=s(6540);const r={},t=i.createContext(r);function a(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);